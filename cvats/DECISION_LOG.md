# Decision Log

- **In-memory persistence fallback** — The API writes CV metadata with Prisma when `DATABASE_URL` is configured. When it is undefined (local dev/tests), we switch to an in-memory repository so the dashboard stays usable without MongoDB.
- **Cloudinary "customer_untrusted" compliance** — Removed unsigned upload presets in favour of server-owned API key/secret flows so Cloudinary treats every upload as trusted, keeping credentials off the client while satisfying delivery security requirements.
- **Server-owned Cloudinary uploads** — `/api/uploads` accepts multipart form data, validates the resume, streams it to Cloudinary with the server API key/secret, persists metadata for the signed-in user, and returns a base64 `__bytes` snapshot so analysis can run immediately without refetching.
- **Secure Cloudinary delivery** — The upload stream enforces `resource_type="raw"`, stores the returned `secure_url` verbatim, and rejects responses that surface non-raw resource types or unexpected delivery modes. Access mode defaults to `authenticated`, enabling signed delivery later without re-uploading.
- **Authenticated Cloudinary fallback** — Analysis prefers inline bytes from the upload response. When they are absent and Cloudinary blocks the public `HEAD`, the service signs a `raw/authenticated` URL server-side before downloading the resume.
- **Credentials auth** — Auth.js handles email/password with bcrypt hashes for quick demo setup. Sessions run on JWTs so API handlers can scope queries. Swap to OAuth/identity provider for production-grade UX + security.
- **Playwright interception** — End-to-end tests configure the `/api/test/cloudinary-stub` helper to emulate Cloudinary streaming, keeping the browser/server flow deterministic without hitting external services.
- **Keyword scoring** — Deterministic keyword matching remains our safety net (case-insensitive, duplicate-safe) and now powers the fallback path directly from the downloaded resume bytes whenever Gemini cannot return valid JSON or the API key is absent.
- **Gemini integration** — AI scoring first streams the Cloudinary binary to Gemini via `inlineData`, forces an `application/json` response that must match `{ atsScore, feedback, keywords }`, and strips any markdown fences before Zod validation. When the model finishes without text we immediately retry through the file-upload API, then delete the uploaded artifact once a response arrives.
- **Gemini resilience** — We cap analysis to two server-side attempts (inline first, file upload second). Any 429 honours `RetryInfo` but sleeps ≤4 s before surfacing a `GeminiQuotaError`. If both attempts yield empty or non-JSON output we throw `GeminiParseError("EMPTY_OR_NON_JSON")` so the API can record an `EMPTY` fallback and fall back to deterministic scoring.
- **Analysis history** — Each run is stored in the new `AnalysisHistory` collection (per CV/user) and the parent CV captures `atsScore` + `analyzedAt` for dashboard badges. The GET handler now returns the most recent entry instead of a full list.
- **Text extraction** — PDFs still rely on a lightweight parser to avoid native deps, while DOCX remains stubbed. The extractor now accepts raw buffers so the fallback path can reuse the downloaded bytes without hitting Cloudinary twice.
- **Pagination & deletion** — The dashboard keeps the first 10 CVs in view with a "Load more" affordance and performs optimistic deletes after confirmation. We refill the list client-side and lean on repository pagination so future filtering/sorting can slot in.
